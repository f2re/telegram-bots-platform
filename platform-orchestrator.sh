#!/bin/bash

# ========================================
# üåê Telegram Bots Platform Orchestration Script
# –ì–ª–∞–≤–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏, —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
# ========================================

set -euo pipefail

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

log_info() { echo -e "${BLUE}‚ÑπÔ∏è ${NC}$1"; }
log_success() { echo -e "${GREEN}‚úÖ ${NC}$1"; }
log_warning() { echo -e "${YELLOW}‚ö†Ô∏è ${NC}$1"; }
log_error() { echo -e "${RED}‚ùå ${NC}$1"; }

show_banner() {
    clear
    echo -e "${CYAN}"
    cat << "EOF"
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë                                                               ‚ïë
‚ïë   üåê TELEGRAM BOTS PLATFORM –û–†–ö–ï–°–¢–†–ê–¢–û–†                        ‚ïë
‚ïë                                                               ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
EOF
    echo -e "${NC}\n"
}

show_menu() {
    echo -e "${CYAN}–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:${NC}\n"
    echo "  1) –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏ —Å–∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–æ–≤–∞—Ç—å —Å–µ—Ä–≤–µ—Ä (setup-server.sh)"
    echo "  2) –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–≥–æ –±–æ—Ç–∞ (add-bot.sh)"
    echo "  3) –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–æ—Ç–∞–º–∏ (bot-manage.sh)"
    echo "  4) –ò—Å–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ (fix-permissions.sh)"
    echo "  5) –í–∫–ª—é—á–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ (setup-grafana-bot.sh)"
    echo "  6) –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –ø–ª–∞—Ç—Ñ–æ—Ä–º—É"
    echo "  7) –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞/–ø–æ–º–æ—â—å"
    echo "  0) –í—ã—Ö–æ–¥"
    echo ""
    read -p "$(echo -e ${YELLOW}–í–∞—à –≤—ã–±–æ—Ä: ${NC})" choice
    case $choice in
        1)
            log_info "–ó–∞–ø—É—Å–∫ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞..."
            sudo ./setup-server.sh
            ;;
        2)
            log_info "–ó–∞–ø—É—Å–∫ –º–∞—Å—Ç–µ—Ä–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –±–æ—Ç–∞..."
            sudo ./add-bot.sh
            ;;
        3)
            log_info "–ó–∞–ø—É—Å–∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–æ—Ç–∞–º–∏..."
            sudo ./bot-manage.sh
            ;;
        4)
            log_info "–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞..."
            sudo bash ./scripts/fix-permissions.sh
            ;;
        5)
            log_info "–í—ã–±–µ—Ä–∏—Ç–µ –±–æ—Ç–∞ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞:"
            read -p "–ò–º—è –±–æ—Ç–∞: " bot_name
            db_name="${bot_name//-/_}_db"
            sudo bash ./scripts/setup-grafana-bot.sh "$bot_name" "$db_name"
            ;;
        6)
            log_info "–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –≤—Å–µ—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã..."
            docker compose -f /opt/monitoring/docker-compose.yml restart
            for bot in /opt/telegram-bots-platform/bots/*; do
                cd "$bot"
                docker compose restart
            done
            log_success "–í—Å–µ —Å–µ—Ä–≤–∏—Å—ã –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω—ã"
            ;;
        7)
            show_help
            ;;
        0)
            log_info "–í—ã—Ö–æ–¥ –∏–∑ –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä–∞"
            exit 0
            ;;
        *)
            log_error "–ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä"
            ;;
    esac
    echo ""
    read -p "–ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è..."
}

show_help() {
    echo -e "${CYAN}–°–ø—Ä–∞–≤–∫–∞ –ø–æ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ:${NC}"
    echo "  - –í—Å–µ —Å–∫—Ä–∏–ø—Ç—ã –∏–∑ –∫–æ—Ä–Ω—è: ./setup-server.sh, ./add-bot.sh, ./bot-manage.sh"
    echo "  - –î–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–æ—Ç–∞–º–∏ –ª—É—á—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å ./bot-manage.sh"
    echo "  - –î–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ Grafana –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ ./scripts/setup-grafana-bot.sh <bot> <db>"
    echo "  - –î–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∞–≤ ./scripts/fix-permissions.sh"
    echo "  - –õ–æ–≥–∏: docker logs -f <container> –∏–ª–∏ —á–µ—Ä–µ–∑ bot-manage.sh"
    echo "  - –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: —Å–º–æ—Ç—Ä–∏—Ç–µ README_RU.md"
    echo "  - –ï—Å–ª–∏ —Å–∫—Ä–∏–ø—Ç –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –¥–µ–π—Å—Ç–≤–∏–µ ‚Äî –ø—Ä–æ—Å—Ç–æ –≤–≤–µ–¥–∏—Ç–µ –Ω—É–∂–Ω—ã–π –ø—É–Ω–∫—Ç –º–µ–Ω—é –∏–ª–∏ –∫–æ–º–∞–Ω–¥—É"
}

main() {
    show_banner
    while true; do
        show_menu
    done
}

main "$@"
